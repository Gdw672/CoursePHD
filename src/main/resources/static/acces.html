<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access</title>
    <style>
        table {
            border: 2px solid #000;
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>

    <table id="myTable">
    </table>
    <button onclick="createTable(3)">Создать таблицу</button>
    <button onclick="addRow()">Добавить элемент</button>
    <button onclick="postNewTable()">Отправить изменения</button>
</head>
<body>
<h1 id="username">Hi, </h1>


<script src="AuthPage.js"></script>

<script>
    var usernameValue = getCookie("username");
    var events = null;

    if (usernameValue) {
        document.getElementById("username").innerText = "Hi, " + usernameValue;
    }

    function createTable(rows) {

        fetch('/getAllEvents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                events = data;
                console.log(events);
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });

    var table = document.getElementById("myTable");
    table.innerHTML = "";

    var headerRow = table.insertRow(0);
    var headers = ["name", "country", "description", "receivedDate", "change", "delete"];
    for (var j = 0; j < 6; j++) {
        var cell = headerRow.insertCell(j);
        cell.innerHTML = headers[j];
    }

    for (var i = 1; i <= events.length; i++) {
        var row = table.insertRow(i);
        for (var j = 0; j < 6; j++) {
            var cell = row.insertCell(j);
            if (cell.cellIndex == 0) {
                var input = document.createElement("input");
                input.value = events[i - 1].name;
                input.disabled = true;
                cell.appendChild(input);
            }
            else if (cell.cellIndex == 1) {
                var input = document.createElement("input");
                input.value = events[i - 1].country;
                input.disabled = true;
                cell.appendChild(input);
            }
            else if (cell.cellIndex == 2) {
                var input = document.createElement("input");
                input.value = events[i - 1].description;
                input.disabled = true;
                cell.appendChild(input);
            }
            else if (cell.cellIndex == 3) {
                var input = document.createElement("input");
                input.value = events[i - 1].receivedDate;
                input.disabled = true;
                cell.appendChild(input);
            }
            else if (cell.cellIndex == 4) {
                var changeButton = document.createElement("button");
                changeButton.innerHTML = "Change";
                changeButton.onclick = function () {
                    var rowToChange = [];
                    var cells = this.parentNode.parentNode.cells;
                    for (var i = 0; i < 4; i++) {
                        rowToChange.push(cells[i].querySelector("input").value);
                    }
                    for (var i = 0; i < 4; i++) {
                        var input = cells[i].querySelector("input");
                        if (input.disabled == false) {
                            input.disabled = true;
                        }
                        else {
                            input.disabled = false;
                        }
                    }
                    console.log(rowToChange);
                };

                cell.appendChild(changeButton);
            }
            else if (cell.cellIndex == 5) {
                var deleteButton = document.createElement("button");
                deleteButton.innerHTML = "Delete";
                deleteButton.onclick = function () {
                    var row = this.parentNode.parentNode;
                    row.remove();
                };
                cell.appendChild(deleteButton);
            }
            else {
              cell.innerHTML = "Строка " + i + ", столбец " + (j + 1);
            }
        }
     }
}

    function extractRowsToArray() {
        var table = document.getElementById("myTable");
        var rowsArray = [];

        for (var i = 1; i < table.rows.length; i++) {
            var cells = table.rows[i].cells;

            var rowObject = {
                name: cells[0].children[0].value,
                country: cells[1].children[0].value,
                description: cells[2].children[0].value,
                receivedDate: cells[3].children[0].value
            };
            rowsArray.push(rowObject);
        }

        return rowsArray;
    }


    function addRow() {
        var table = document.getElementById("myTable");
        var newRow = table.insertRow();

        for (var i = 0; i < 6; i++) {
            if (i < 4) {
                var cell = newRow.insertCell(-1);
                var input = document.createElement("input");
                input.value = "";
                input.disabled = true;
                cell.appendChild(input);
            }
            else if (i == 4) {
                var cell = newRow.insertCell(-1);
                var changeButton = document.createElement("button");
                changeButton.innerHTML = "Change";
                changeButton.onclick = function () {
                    var rowToChange = [];
                    var cells = this.parentNode.parentNode.cells;
                    for (var i = 0; i < 4; i++) {
                        rowToChange.push(cells[i].querySelector("input").value);
                    }
                    for (var i = 0; i < 4; i++) {
                        var input = cells[i].querySelector("input");
                        if (input.disabled == false) {
                            input.disabled = true;
                        }
                        else {
                            input.disabled = false;
                        }
                    }
                    console.log(rowToChange);
                };

                cell.appendChild(changeButton);
            }
            else if (i == 5) {
                var cell = newRow.insertCell(-1);
                var deleteButton = document.createElement("button");
                deleteButton.innerHTML = "Delete";
                deleteButton.onclick = function () {
                    var row = this.parentNode.parentNode;
                    row.remove();
                };
                cell.appendChild(deleteButton);
            }
        }
    }


    function postNewTable() {
        var table = document.getElementById("myTable");
        var newEvents = [];


        var newEvents = extractRowsToArray();

        var jsonData = JSON.stringify(newEvents);

        console.log(jsonData);

        fetch('/updateEvents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: jsonData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }
</script>
</body>
</html>
